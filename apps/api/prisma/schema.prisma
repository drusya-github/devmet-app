generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String             @id @default(uuid())
  email                   String             @unique
  name                    String
  avatarUrl               String?
  createdAt               DateTime           @default(now())
  updatedAt               DateTime           @updatedAt
  accessToken             String
  deletedAt               DateTime?
  lastLoginAt             DateTime?
  lastLoginIp             String?
  loginCount              Int                @default(0)
  notificationPreferences Json?              @default("{}")
  preferences             Json?              @default("{}")
  refreshToken            String?
  tokenExpiresAt          DateTime?
  githubId                BigInt             @unique
  apiKeys                 ApiKey[]
  auditLogs               AuditLog[]
  commits                 Commit[]           @relation("CommitAuthor")
  developerMetrics        DeveloperMetric[]
  issues                  Issue[]            @relation("IssueAuthor")
  pullRequests            PullRequest[]      @relation("PRAuthor")
  organizations           UserOrganization[]

  @@index([githubId])
  @@index([email])
  @@map("users")
}

model Organization {
  id                String             @id @default(uuid())
  name              String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  planLimits        Json?
  settings          Json?
  slug              String             @unique
  githubId          BigInt?            @unique
  planType          PlanType           @default(FREE)
  apiKeys           ApiKey[]
  auditLogs         AuditLog[]
  developerMetrics  DeveloperMetric[]
  notificationRules NotificationRule[]
  repositories      Repository[]
  teamMetrics       TeamMetric[]
  members           UserOrganization[]

  @@index([slug])
  @@index([githubId])
  @@map("organizations")
}

model UserOrganization {
  userId         String
  organizationId String
  role           Role         @default(MEMBER)
  joinedAt       DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, role])
  @@map("user_organizations")
}

model Repository {
  id               String            @id @default(uuid())
  organizationId   String
  name             String
  fullName         String
  isPrivate        Boolean           @default(false)
  language         String?
  webhookSecret    String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  aiReviewEnabled  Boolean           @default(true)
  description      String?
  lastSyncedAt     DateTime?
  sensitivityLevel SensitivityLevel  @default(NORMAL)
  syncStatus       SyncStatus        @default(PENDING)
  webhookRateLimit Int               @default(1000)
  githubId         BigInt            @unique
  webhookId        BigInt?
  commits          Commit[]
  events           Event[]
  issues           Issue[]
  pullRequests     PullRequest[]
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stats            RepositoryStats[]

  @@index([organizationId])
  @@index([githubId])
  @@index([organizationId, syncStatus])
  @@index([syncStatus])
  @@map("repositories")
}

model RepositoryStats {
  id                 String     @id @default(uuid())
  date               DateTime   @db.Date
  commits            Int        @default(0)
  prsOpened          Int        @default(0)
  prsMerged          Int        @default(0)
  prsClosed          Int        @default(0)
  issuesOpened       Int        @default(0)
  issuesClosed       Int        @default(0)
  createdAt          DateTime   @default(now())
  filesChanged       Int        @default(0)
  forks              Int?
  linesAdded         Int        @default(0)
  linesDeleted       Int        @default(0)
  repoId             String
  stars              Int?
  topContributor     String?
  uniqueContributors Int        @default(0)
  updatedAt          DateTime   @updatedAt
  watchers           Int?
  repository         Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@unique([repoId, date])
  @@index([repoId, date])
  @@index([date])
  @@map("repository_stats")
}

model Event {
  id             String     @id @default(uuid())
  type           String
  authorId       String?
  payload        Json
  createdAt      DateTime   @default(now())
  action         String?
  authorGithubId BigInt?
  processed      Boolean    @default(false)
  processedAt    DateTime?
  receivedAt     DateTime   @default(now())
  repoId         String
  githubId       BigInt     @unique
  repository     Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@unique([githubId, repoId])
  @@index([repoId, createdAt])
  @@index([createdAt])
  @@index([processed, createdAt])
  @@index([repoId, type, createdAt])
  @@map("events")
}

model Commit {
  id             String     @id @default(uuid())
  sha            String
  message        String
  authorId       String?
  additions      Int        @default(0)
  deletions      Int        @default(0)
  createdAt      DateTime   @default(now())
  authorEmail    String?
  authorGithubId BigInt?
  authorName     String?
  committedAt    DateTime
  githubId       String     @unique
  repoId         String
  author         User?      @relation("CommitAuthor", fields: [authorId], references: [id])
  repository     Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@index([repoId, committedAt])
  @@index([authorId, committedAt])
  @@index([committedAt])
  @@map("commits")
}

model PullRequest {
  id             String     @id @default(uuid())
  number         Int
  title          String
  authorId       String?
  additions      Int        @default(0)
  deletions      Int        @default(0)
  filesChanged   Int        @default(0)
  createdAt      DateTime
  updatedAt      DateTime
  closedAt       DateTime?
  mergedAt       DateTime?
  authorGithubId BigInt?
  repoId         String
  state          PRState    @default(OPEN)
  githubId       BigInt     @unique
  aiReviews      AIReview?
  author         User?      @relation("PRAuthor", fields: [authorId], references: [id])
  repository     Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@unique([repoId, number])
  @@index([repoId, state, createdAt])
  @@index([authorId, createdAt])
  @@index([state, createdAt])
  @@map("pull_requests")
}

model Issue {
  id             String     @id @default(uuid())
  number         Int
  title          String
  authorId       String?
  createdAt      DateTime
  closedAt       DateTime?
  authorGithubId BigInt?
  repoId         String
  state          IssueState @default(OPEN)
  githubId       BigInt     @unique
  author         User?      @relation("IssueAuthor", fields: [authorId], references: [id])
  repository     Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@unique([repoId, number])
  @@index([repoId, state])
  @@index([authorId, createdAt])
  @@index([state, createdAt])
  @@map("issues")
}

model DeveloperMetric {
  id               String       @id @default(uuid())
  userId           String
  date             DateTime     @db.Date
  commits          Int          @default(0)
  prsOpened        Int          @default(0)
  prsReviewed      Int          @default(0)
  issuesResolved   Int          @default(0)
  linesAdded       Int          @default(0)
  linesDeleted     Int          @default(0)
  avgCodeQuality   Float?
  avgCommitTime    String?
  avgIssueTime     Int          @default(0)
  avgPrSize        Int          @default(0)
  avgReviewTime    Int          @default(0)
  bugFixed         Int          @default(0)
  bugIntroduced    Int          @default(0)
  commitsLateNight Int          @default(0)
  commitsOnWeekend Int          @default(0)
  createdAt        DateTime     @default(now())
  filesChanged     Int          @default(0)
  issuesOpened     Int          @default(0)
  organizationId   String
  prsClosed        Int          @default(0)
  prsMerged        Int          @default(0)
  reviewComments   Int          @default(0)
  updatedAt        DateTime     @updatedAt
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, date])
  @@index([organizationId, date])
  @@index([userId, date])
  @@index([date])
  @@map("developer_metrics")
}

model TeamMetric {
  id                    String       @id @default(uuid())
  organizationId        String
  date                  DateTime     @db.Date
  velocity              Int          @default(0)
  deploymentFrequency   Int          @default(0)
  buildSuccessRate      Float?
  activeContributors    Int          @default(0)
  avgPrCycleTime        Int          @default(0)
  avgPrQueueTime        Int          @default(0)
  avgReviewTime         Int          @default(0)
  changeFailureRate     Float?
  codeQualityScore      Float?
  createdAt             DateTime     @default(now())
  deploymentSuccessRate Float?
  issueBacklog          Int          @default(0)
  knowledgeDistribution Float?
  meanTimeToRecovery    Int?
  prQueueLength         Int          @default(0)
  prReviewCoverage      Float?
  testCoverage          Float?
  totalCommits          Int          @default(0)
  totalIssuesClosed     Int          @default(0)
  totalPrsMerged        Int          @default(0)
  totalPrsOpened        Int          @default(0)
  updatedAt             DateTime     @updatedAt
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date])
  @@index([organizationId, date])
  @@index([date])
  @@map("team_metrics")
}

model AIReview {
  id                  String      @id @default(uuid())
  riskScore           Int
  suggestions         Json
  createdAt           DateTime    @default(now())
  analysis            String
  bugsPotential       Int         @default(0)
  githubCommentId     BigInt?
  isSharedToGithub    Boolean     @default(false)
  modelVersion        String      @default("claude-3-sonnet")
  performanceConcerns Int         @default(0)
  prId                String      @unique
  processingTime      Int?
  qualityIssues       Int         @default(0)
  tokensUsed          Int?
  updatedAt           DateTime    @updatedAt
  visibility          String      @default("team")
  complexity          String
  securityIssues      Int         @default(0)
  pullRequest         PullRequest @relation(fields: [prId], references: [id], onDelete: Cascade)

  @@index([prId])
  @@index([riskScore])
  @@index([createdAt])
  @@map("ai_reviews")
}

model NotificationRule {
  id             String            @id @default(uuid())
  organizationId String
  type           String
  conditions     Json
  channels       String[]
  createdAt      DateTime          @default(now())
  channelConfig  Json?
  createdBy      String
  isActive       Boolean           @default(true)
  name           String
  updatedAt      DateTime          @updatedAt
  logs           NotificationLog[]
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([type, isActive])
  @@map("notification_rules")
}

model NotificationLog {
  id           String             @id @default(uuid())
  ruleId       String
  triggeredAt  DateTime
  deliveredAt  DateTime?
  channel      String
  failedReason String?
  message      String
  metadata     Json?
  recipientId  String
  title        String
  status       NotificationStatus
  rule         NotificationRule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([recipientId, triggeredAt])
  @@index([ruleId, triggeredAt])
  @@index([status, triggeredAt])
  @@map("notification_logs")
}

model ApiKey {
  id             String       @id @default(uuid())
  userId         String
  organizationId String
  name           String
  keyHash        String       @unique
  lastFour       String
  scopes         String[]
  rateLimit      Int          @default(100)
  lastUsedAt     DateTime?
  totalRequests  Int          @default(0)
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("api_keys")
}

model AuditLog {
  id             String        @id @default(uuid())
  userId         String
  organizationId String?
  action         String
  resource       String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  requestId      String?
  status         String
  errorMessage   String?
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

enum Role {
  ADMIN
  MEMBER
  VIEWER
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum PRState {
  OPEN
  CLOSED
  MERGED
}

enum IssueState {
  OPEN
  CLOSED
}

enum SyncStatus {
  PENDING
  SYNCING
  ACTIVE
  ERROR
  PAUSED
}

enum SensitivityLevel {
  NORMAL
  SENSITIVE
  CONFIDENTIAL
}

enum NotificationStatus {
  SENT
  FAILED
  BOUNCED
  PENDING
}
